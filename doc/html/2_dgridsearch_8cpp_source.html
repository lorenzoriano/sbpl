<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SBPL: src/utils/2Dgridsearch.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">SBPL
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('2_dgridsearch_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/utils/2Dgridsearch.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="2_dgridsearch_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2008, Maxim Likhachev</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> * </span>
<a name="l00005"></a>00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00006"></a>00006 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00007"></a>00007 <span class="comment"> * </span>
<a name="l00008"></a>00008 <span class="comment"> *     * Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *       notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *       notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *       documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> *     * Neither the name of the University of Pennsylvania nor the names of its</span>
<a name="l00014"></a>00014 <span class="comment"> *       contributors may be used to endorse or promote products derived from</span>
<a name="l00015"></a>00015 <span class="comment"> *       this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> * </span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<a name="l00018"></a>00018 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00019"></a>00019 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00020"></a>00020 <span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="l00021"></a>00021 <span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00022"></a>00022 <span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00023"></a>00023 <span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00024"></a>00024 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00025"></a>00025 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00026"></a>00026 <span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00027"></a>00027 <span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00028"></a>00028 <span class="comment"> */</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;ctime&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="2_dgridsearch_8h.html">sbpl/utils/2Dgridsearch.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sbpl/utils/heap.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="list_8h.html">sbpl/utils/list.h</a>&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">using namespace </span>std;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">//---------------------initialization and destruction routines--------------------------------------------------------</span>
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="class_s_b_p_l2_d_grid_search.html#a3b8883f68c03ae1532e45fea9dfba85b">00040</a> <a class="code" href="class_s_b_p_l2_d_grid_search.html#a3b8883f68c03ae1532e45fea9dfba85b">SBPL2DGridSearch::SBPL2DGridSearch</a>(<span class="keywordtype">int</span> width_x, <span class="keywordtype">int</span> height_y, <span class="keywordtype">float</span> cellsize_m)
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042     iteration_ = 0;
<a name="l00043"></a>00043     searchStates2D_ = NULL;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     width_ = width_x;
<a name="l00046"></a>00046     height_ = height_y;
<a name="l00047"></a>00047     cellSize_m_ = cellsize_m;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     startX_ = -1;
<a name="l00050"></a>00050     startY_ = -1;
<a name="l00051"></a>00051     goalX_ = -1;
<a name="l00052"></a>00052     goalY_ = -1;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     largestcomputedoptf_ = 0;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     <span class="comment">//compute dx, dy, dxintersects and dyintersects arrays</span>
<a name="l00057"></a>00057     computedxy();
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     term_condition_usedlast = <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba0040a65fda1344baec0ccaac1f22e14e">SBPL_2DGRIDSEARCH_TERM_CONDITION_ALLCELLS</a>;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061     <span class="comment">//allocate memory</span>
<a name="l00062"></a>00062     OPEN2D_ = <span class="keyword">new</span> <a class="code" href="class_c_int_heap.html">CIntHeap</a>(width_x * height_y);
<a name="l00063"></a>00063     <span class="keywordflow">if</span> (!createSearchStates2D()) {
<a name="l00064"></a>00064         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: failed to create searchstatespace2D\n&quot;</span>);
<a name="l00065"></a>00065         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_s_b_p_l___exception.html">SBPL_Exception</a>();
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <span class="comment">//by default, OPEN is implemented as heap</span>
<a name="l00069"></a>00069     OPEN2DBLIST_ = NULL;
<a name="l00070"></a>00070     OPENtype_ = <a class="code" href="2_dgridsearch_8h.html#a0580f285fb96a3d7ea2f60c3d57bddb5aca751c4cf514f1dc6bf9be180e0e719d">SBPL_2DGRIDSEARCH_OPENTYPE_HEAP</a>;
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="class_s_b_p_l2_d_grid_search.html#a75b428f1e5b6b507a607e6451c36dc5f">00073</a> <span class="keywordtype">bool</span> <a class="code" href="class_s_b_p_l2_d_grid_search.html#a75b428f1e5b6b507a607e6451c36dc5f" title="the priority data structure used - it affects efficiency (can be either heap or sliding buckets...">SBPL2DGridSearch::setOPENdatastructure</a>(<a class="code" href="2_dgridsearch_8h.html#a0580f285fb96a3d7ea2f60c3d57bddb5">SBPL_2DGRIDSEARCH_OPENTYPE</a> OPENtype)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075     OPENtype_ = OPENtype;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="keywordflow">switch</span> (OPENtype_) {
<a name="l00078"></a>00078     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a0580f285fb96a3d7ea2f60c3d57bddb5aca751c4cf514f1dc6bf9be180e0e719d">SBPL_2DGRIDSEARCH_OPENTYPE_HEAP</a>:
<a name="l00079"></a>00079         <span class="comment">//this is the default, nothing else needs to be done</span>
<a name="l00080"></a>00080         <span class="keywordflow">break</span>;
<a name="l00081"></a>00081     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a0580f285fb96a3d7ea2f60c3d57bddb5ac92d13518f588a31b9a690e4ce4d9800">SBPL_2DGRIDSEARCH_OPENTYPE_SLIDINGBUCKETS</a>:
<a name="l00082"></a>00082         <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>(<span class="stringliteral">&quot;setting OPEN2D data structure to sliding buckets\n&quot;</span>);
<a name="l00083"></a>00083         <span class="keywordflow">if</span> (OPEN2DBLIST_ == NULL) {
<a name="l00084"></a>00084             <span class="comment">//create sliding buckets</span>
<a name="l00085"></a>00085             <span class="comment">//compute max distance for edge</span>
<a name="l00086"></a>00086             <span class="keywordtype">int</span> maxdistance = 0;
<a name="l00087"></a>00087             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dind = 0; dind &lt; <a class="code" href="2_dgridsearch_8h.html#ac00b6018cf9d45085302dc54d62128b0">SBPL_2DGRIDSEARCH_NUMOF2DDIRS</a>; dind++) {
<a name="l00088"></a>00088                 maxdistance = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(maxdistance, dxy_distance_mm_[dind]);
<a name="l00089"></a>00089             }
<a name="l00090"></a>00090             <span class="keywordtype">int</span> bucketsize = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(1000, this-&gt;width_ + this-&gt;height_);
<a name="l00091"></a>00091             <span class="keywordtype">int</span> numofbuckets = 255 * maxdistance;
<a name="l00092"></a>00092             <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>(<span class="stringliteral">&quot;creating sliding bucket-based OPEN2D %d buckets, each bucket of size %d ...&quot;</span>, numofbuckets,
<a name="l00093"></a>00093                         bucketsize);
<a name="l00094"></a>00094             OPEN2DBLIST_ = <span class="keyword">new</span> <a class="code" href="class_c_sliding_bucket.html">CSlidingBucket</a>(numofbuckets, bucketsize);
<a name="l00095"></a>00095             <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>(<span class="stringliteral">&quot;done\n&quot;</span>);
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097         <span class="comment">//delete other data structures</span>
<a name="l00098"></a>00098         <span class="keywordflow">if</span> (OPEN2D_ != NULL) {
<a name="l00099"></a>00099             OPEN2D_-&gt;makeemptyheap();
<a name="l00100"></a>00100             <span class="keyword">delete</span> OPEN2D_;
<a name="l00101"></a>00101             OPEN2D_ = NULL;
<a name="l00102"></a>00102         }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="keywordflow">break</span>;
<a name="l00105"></a>00105     <span class="keywordflow">default</span>:
<a name="l00106"></a>00106         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: unknown data structure type = %d for OPEN2D\n&quot;</span>, OPENtype_);
<a name="l00107"></a>00107         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_s_b_p_l___exception.html">SBPL_Exception</a>();
<a name="l00108"></a>00108     };
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="keywordtype">bool</span> SBPL2DGridSearch::createSearchStates2D(<span class="keywordtype">void</span>)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115     <span class="keywordtype">int</span> x, y;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">if</span> (searchStates2D_ != NULL) {
<a name="l00118"></a>00118         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: We already have a non-NULL search states array\n&quot;</span>);
<a name="l00119"></a>00119         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     searchStates2D_ = <span class="keyword">new</span> <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>*[width_];
<a name="l00123"></a>00123     <span class="keywordflow">for</span> (x = 0; x &lt; width_; x++) {
<a name="l00124"></a>00124         searchStates2D_[x] = <span class="keyword">new</span> <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>[height_];
<a name="l00125"></a>00125         <span class="keywordflow">for</span> (y = 0; y &lt; height_; y++) {
<a name="l00126"></a>00126             searchStates2D_[x][y].<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> = iteration_;
<a name="l00127"></a>00127             searchStates2D_[x][y].x = x;
<a name="l00128"></a>00128             searchStates2D_[x][y].y = y;
<a name="l00129"></a>00129             initializeSearchState2D(&amp;searchStates2D_[x][y]);
<a name="l00130"></a>00130         }
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="keyword">inline</span> <span class="keywordtype">void</span> SBPL2DGridSearch::initializeSearchState2D(<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>* state2D)
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137     state2D-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>;
<a name="l00138"></a>00138     state2D-&gt;<a class="code" href="class_abstract_search_state.html#a6028421591a4fff1e72a3917fe1c7d7e" title="index of the state in the heap, typically used for membership in OPEN">heapindex</a> = 0;
<a name="l00139"></a>00139     state2D-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> = iteration_;
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="class_s_b_p_l2_d_grid_search.html#aa28f098351326e9fe328bba79b0882ed">00142</a> <span class="keywordtype">void</span> <a class="code" href="class_s_b_p_l2_d_grid_search.html#aa28f098351326e9fe328bba79b0882ed" title="destroys the search and clears all memory">SBPL2DGridSearch::destroy</a>()
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144     <span class="comment">// destroy the OPEN list:</span>
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (OPEN2D_ != NULL) {
<a name="l00146"></a>00146         OPEN2D_-&gt;makeemptyheap();
<a name="l00147"></a>00147         <span class="keyword">delete</span> OPEN2D_;
<a name="l00148"></a>00148         OPEN2D_ = NULL;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="comment">// destroy the 2D states:</span>
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (searchStates2D_ != NULL) {
<a name="l00153"></a>00153         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; width_; x++) {
<a name="l00154"></a>00154             <span class="keyword">delete</span>[] searchStates2D_[x];
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156         <span class="keyword">delete</span>[] searchStates2D_;
<a name="l00157"></a>00157         searchStates2D_ = NULL;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (OPEN2DBLIST_ != NULL) {
<a name="l00161"></a>00161         <span class="keyword">delete</span> OPEN2DBLIST_;
<a name="l00162"></a>00162         OPEN2DBLIST_ = NULL;
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="keywordtype">void</span> SBPL2DGridSearch::computedxy()
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <span class="comment">//initialize some constants for 2D search</span>
<a name="l00169"></a>00169     dx_[0] = 1;
<a name="l00170"></a>00170     dy_[0] = 1;
<a name="l00171"></a>00171     dx0intersects_[0] = -1;
<a name="l00172"></a>00172     dy0intersects_[0] = -1;
<a name="l00173"></a>00173     dx_[1] = 1;
<a name="l00174"></a>00174     dy_[1] = 0;
<a name="l00175"></a>00175     dx0intersects_[1] = -1;
<a name="l00176"></a>00176     dy0intersects_[1] = -1;
<a name="l00177"></a>00177     dx_[2] = 1;
<a name="l00178"></a>00178     dy_[2] = -1;
<a name="l00179"></a>00179     dx0intersects_[2] = -1;
<a name="l00180"></a>00180     dy0intersects_[2] = -1;
<a name="l00181"></a>00181     dx_[3] = 0;
<a name="l00182"></a>00182     dy_[3] = 1;
<a name="l00183"></a>00183     dx0intersects_[3] = -1;
<a name="l00184"></a>00184     dy0intersects_[3] = -1;
<a name="l00185"></a>00185     dx_[4] = 0;
<a name="l00186"></a>00186     dy_[4] = -1;
<a name="l00187"></a>00187     dx0intersects_[4] = -1;
<a name="l00188"></a>00188     dy0intersects_[4] = -1;
<a name="l00189"></a>00189     dx_[5] = -1;
<a name="l00190"></a>00190     dy_[5] = 1;
<a name="l00191"></a>00191     dx0intersects_[5] = -1;
<a name="l00192"></a>00192     dy0intersects_[5] = -1;
<a name="l00193"></a>00193     dx_[6] = -1;
<a name="l00194"></a>00194     dy_[6] = 0;
<a name="l00195"></a>00195     dx0intersects_[6] = -1;
<a name="l00196"></a>00196     dy0intersects_[6] = -1;
<a name="l00197"></a>00197     dx_[7] = -1;
<a name="l00198"></a>00198     dy_[7] = -1;
<a name="l00199"></a>00199     dx0intersects_[7] = -1;
<a name="l00200"></a>00200     dy0intersects_[7] = -1;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment">//Note: these actions have to be starting at 8 and through 15, since they </span>
<a name="l00203"></a>00203     <span class="comment">//get multiplied correspondingly in Dijkstra&#39;s search based on index</span>
<a name="l00204"></a>00204 <span class="preprocessor">#if SBPL_2DGRIDSEARCH_NUMOF2DDIRS == 16</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>    dx_[8] = 2; dy_[8] = 1;
<a name="l00206"></a>00206     dx0intersects_[8] = 1; dy0intersects_[8] = 0; dx1intersects_[8] = 1; dy1intersects_[8] = 1;
<a name="l00207"></a>00207     dx_[9] = 1; dy_[9] = 2;
<a name="l00208"></a>00208     dx0intersects_[9] = 0; dy0intersects_[9] = 1; dx1intersects_[9] = 1; dy1intersects_[9] = 1;
<a name="l00209"></a>00209     dx_[10] = -1; dy_[10] = 2;
<a name="l00210"></a>00210     dx0intersects_[10] = 0; dy0intersects_[10] = 1; dx1intersects_[10] = -1; dy1intersects_[10] = 1;
<a name="l00211"></a>00211     dx_[11] = -2; dy_[11] = 1;
<a name="l00212"></a>00212     dx0intersects_[11] = -1; dy0intersects_[11] = 0; dx1intersects_[11] = -1; dy1intersects_[11] = 1;
<a name="l00213"></a>00213     dx_[12] = -2; dy_[12] = -1;
<a name="l00214"></a>00214     dx0intersects_[12] = -1; dy0intersects_[12] = 0; dx1intersects_[12] = -1; dy1intersects_[12] = -1;
<a name="l00215"></a>00215     dx_[13] = -1; dy_[13] = -2;
<a name="l00216"></a>00216     dx0intersects_[13] = 0; dy0intersects_[13] = -1; dx1intersects_[13] = -1; dy1intersects_[13] = -1;
<a name="l00217"></a>00217     dx_[14] = 1; dy_[14] = -2;
<a name="l00218"></a>00218     dx0intersects_[14] = 0; dy0intersects_[14] = -1; dx1intersects_[14] = 1; dy1intersects_[14] = -1;
<a name="l00219"></a>00219     dx_[15] = 2; dy_[15] = -1;
<a name="l00220"></a>00220     dx0intersects_[15] = 1; dy0intersects_[15] = 0; dx1intersects_[15] = 1; dy1intersects_[15] = -1;
<a name="l00221"></a>00221 <span class="preprocessor">#endif          </span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a>00223     <span class="comment">//compute distances</span>
<a name="l00224"></a>00224     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dind = 0; dind &lt; <a class="code" href="2_dgridsearch_8h.html#ac00b6018cf9d45085302dc54d62128b0">SBPL_2DGRIDSEARCH_NUMOF2DDIRS</a>; dind++) {
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (dx_[dind] != 0 &amp;&amp; dy_[dind] != 0) {
<a name="l00227"></a>00227             <span class="keywordflow">if</span> (dind &lt;= 7)
<a name="l00228"></a>00228                 <span class="comment">//the cost of a diagonal move in millimeters</span>
<a name="l00229"></a>00229                 dxy_distance_mm_[dind] = (int)(cellSize_m_ * 1414); 
<a name="l00230"></a>00230             <span class="keywordflow">else</span>
<a name="l00231"></a>00231                 <span class="comment">//the cost of a move to 1,2 or 2,1 or so on in millimeters</span>
<a name="l00232"></a>00232                 dxy_distance_mm_[dind] = (int)(cellSize_m_ * 2236); 
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234         <span class="keywordflow">else</span>
<a name="l00235"></a>00235             dxy_distance_mm_[dind] = (int)(cellSize_m_ * 1000); <span class="comment">//the cost of a horizontal move in millimeters</span>
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="comment">//--------------------------------------------------------------------------------------------------------------------</span>
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">//-----------------------------------------debugging functions----------------------------------------------------------</span>
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="class_s_b_p_l2_d_grid_search.html#ab33e12664933643bb09bbd8c035b2e70">00243</a> <span class="keywordtype">void</span> <a class="code" href="class_s_b_p_l2_d_grid_search.html#ab33e12664933643bb09bbd8c035b2e70" title="print all the values">SBPL2DGridSearch::printvalues</a>()
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">//--------------------------------------------------------------------------------------------------------------------</span>
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">//-----------------------------------------main functions--------------------------------------------------------------</span>
<a name="l00251"></a>00251 
<a name="l00252"></a><a class="code" href="class_s_b_p_l2_d_grid_search.html#afc66aa13ab59aaf6b84fb31e72a4cbb8">00252</a> <span class="keywordtype">bool</span> <a class="code" href="class_s_b_p_l2_d_grid_search.html#afc66aa13ab59aaf6b84fb31e72a4cbb8" title="performs search itself. All costs are given as cost(cell1, cell2) = Euclidean distance*1000*(max(cell...">SBPL2DGridSearch::search</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>** Grid2D, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obsthresh, <span class="keywordtype">int</span> startx_c, <span class="keywordtype">int</span> starty_c, <span class="keywordtype">int</span> goalx_c,
<a name="l00253"></a>00253                               <span class="keywordtype">int</span> goaly_c, <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86b">SBPL_2DGRIDSEARCH_TERM_CONDITION</a> termination_condition)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="keywordflow">switch</span> (OPENtype_) {
<a name="l00257"></a>00257     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a0580f285fb96a3d7ea2f60c3d57bddb5aca751c4cf514f1dc6bf9be180e0e719d">SBPL_2DGRIDSEARCH_OPENTYPE_HEAP</a>:
<a name="l00258"></a>00258         <span class="keywordflow">return</span> SBPL2DGridSearch::search_withheap(Grid2D, obsthresh, startx_c, starty_c, goalx_c, goaly_c,
<a name="l00259"></a>00259                                                  termination_condition);
<a name="l00260"></a>00260         <span class="keywordflow">break</span>;
<a name="l00261"></a>00261     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a0580f285fb96a3d7ea2f60c3d57bddb5ac92d13518f588a31b9a690e4ce4d9800">SBPL_2DGRIDSEARCH_OPENTYPE_SLIDINGBUCKETS</a>:
<a name="l00262"></a>00262         <span class="keywordflow">return</span> SBPL2DGridSearch::search_withslidingbuckets(Grid2D, obsthresh, startx_c, starty_c, goalx_c, goaly_c,
<a name="l00263"></a>00263                                                            termination_condition);
<a name="l00264"></a>00264         <span class="keywordflow">break</span>;
<a name="l00265"></a>00265     <span class="keywordflow">default</span>:
<a name="l00266"></a>00266         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: unknown data structure type = %d for OPEN2D\n&quot;</span>, OPENtype_);
<a name="l00267"></a>00267         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_s_b_p_l___exception.html">SBPL_Exception</a>();
<a name="l00268"></a>00268     };
<a name="l00269"></a>00269     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="keywordtype">bool</span> SBPL2DGridSearch::search_withheap(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>** Grid2D, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obsthresh, <span class="keywordtype">int</span> startx_c, <span class="keywordtype">int</span> starty_c,
<a name="l00273"></a>00273                                        <span class="keywordtype">int</span> goalx_c, <span class="keywordtype">int</span> goaly_c, <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86b">SBPL_2DGRIDSEARCH_TERM_CONDITION</a> termination_condition)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchExpState = NULL;
<a name="l00276"></a>00276     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchPredState = NULL;
<a name="l00277"></a>00277     <span class="keywordtype">int</span> numofExpands = 0;
<a name="l00278"></a>00278     <span class="keywordtype">int</span> key;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="comment">//get the current time</span>
<a name="l00281"></a>00281     clock_t starttime = clock();
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="comment">//closed = 0</span>
<a name="l00284"></a>00284     iteration_++;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">//init start and goal coordinates</span>
<a name="l00287"></a>00287     startX_ = startx_c;
<a name="l00288"></a>00288     startY_ = starty_c;
<a name="l00289"></a>00289     goalX_ = goalx_c;
<a name="l00290"></a>00290     goalY_ = goaly_c;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="comment">//clear the heap</span>
<a name="l00293"></a>00293     OPEN2D_-&gt;makeemptyheap();
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="comment">//set the term. condition</span>
<a name="l00296"></a>00296     term_condition_usedlast = termination_condition;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">//check the validity of start/goal</span>
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (!withinMap(startx_c, starty_c) || !withinMap(goalx_c, goaly_c)) {
<a name="l00300"></a>00300         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: grid2Dsearch is called on invalid start (%d %d) or goal(%d %d)\n&quot;</span>, startx_c, starty_c,
<a name="l00301"></a>00301                    goalx_c, goaly_c);
<a name="l00302"></a>00302         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="comment">// initialize the start and goal states</span>
<a name="l00306"></a>00306     searchExpState = &amp;searchStates2D_[startX_][startY_];
<a name="l00307"></a>00307     initializeSearchState2D(searchExpState);
<a name="l00308"></a>00308     initializeSearchState2D(&amp;searchStates2D_[goalx_c][goaly_c]);
<a name="l00309"></a>00309     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>* search2DGoalState = &amp;searchStates2D_[goalx_c][goaly_c];
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="comment">//seed the search</span>
<a name="l00312"></a>00312     searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = 0;
<a name="l00313"></a>00313     key = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>;
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (termination_condition == <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86bafae8e152f0a268a7d66f24126d785f4c">SBPL_2DGRIDSEARCH_TERM_CONDITION_OPTPATHFOUND</a>)
<a name="l00315"></a>00315         <span class="comment">//use h-values only if we are NOT computing all state values</span>
<a name="l00316"></a>00316         key = key + <a class="code" href="2_dgridsearch_8h.html#a37f43da9f86b8e0ff5a6186c32f0ee8f">SBPL_2DGRIDSEARCH_HEUR2D</a>(startX_, startY_); 
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     OPEN2D_-&gt;insertheap(searchExpState, key);
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="comment">//set the termination condition</span>
<a name="l00321"></a>00321     <span class="keywordtype">float</span> term_factor = 0.0;
<a name="l00322"></a>00322     <span class="keywordflow">switch</span> (termination_condition) {
<a name="l00323"></a>00323     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86bafae8e152f0a268a7d66f24126d785f4c">SBPL_2DGRIDSEARCH_TERM_CONDITION_OPTPATHFOUND</a>:
<a name="l00324"></a>00324         term_factor = 1;
<a name="l00325"></a>00325         <span class="keywordflow">break</span>;
<a name="l00326"></a>00326     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86bae9b331875a0820a23510216a1ad8b65a">SBPL_2DGRIDSEARCH_TERM_CONDITION_20PERCENTOVEROPTPATH</a>:
<a name="l00327"></a>00327         term_factor = (float)(1.0 / 1.2);
<a name="l00328"></a>00328         <span class="keywordflow">break</span>;
<a name="l00329"></a>00329     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba29052a8c8b576fef6ee4de7e3fef0616">SBPL_2DGRIDSEARCH_TERM_CONDITION_TWOTIMESOPTPATH</a>:
<a name="l00330"></a>00330         term_factor = 0.5;
<a name="l00331"></a>00331         <span class="keywordflow">break</span>;
<a name="l00332"></a>00332     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba4894b5f52245db38fd6a243da74b0bff">SBPL_2DGRIDSEARCH_TERM_CONDITION_THREETIMESOPTPATH</a>:
<a name="l00333"></a>00333         term_factor = (float)(1.0 / 3.0);
<a name="l00334"></a>00334         <span class="keywordflow">break</span>;
<a name="l00335"></a>00335     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba0040a65fda1344baec0ccaac1f22e14e">SBPL_2DGRIDSEARCH_TERM_CONDITION_ALLCELLS</a>:
<a name="l00336"></a>00336         term_factor = 0.0;
<a name="l00337"></a>00337         <span class="keywordflow">break</span>;
<a name="l00338"></a>00338     <span class="keywordflow">default</span>:
<a name="l00339"></a>00339         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: incorrect termination factor for grid2Dsearch\n&quot;</span>);
<a name="l00340"></a>00340         term_factor = 0.0;
<a name="l00341"></a>00341     };
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordtype">char</span> *pbClosed = (<span class="keywordtype">char</span>*)calloc(1, width_ * height_);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="comment">//the main repetition of expansions</span>
<a name="l00346"></a>00346     <span class="keywordflow">while</span> (!OPEN2D_-&gt;emptyheap() &amp;&amp;
<a name="l00347"></a>00347            <a class="code" href="utils_8h.html#ad6d0138bf7e2cdaabeedc3fea40767ad">__min</a>(<a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>, search2DGoalState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>) &gt; term_factor * OPEN2D_-&gt;getminkeyheap())
<a name="l00348"></a>00348     {
<a name="l00349"></a>00349         <span class="comment">//get the next state for expansion</span>
<a name="l00350"></a>00350         searchExpState = (<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>*)OPEN2D_-&gt;deleteminheap();
<a name="l00351"></a>00351         numofExpands++;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="keywordtype">int</span> exp_x = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a752505e845397c09eb0916f1474166ad" title="coordinates">x</a>;
<a name="l00354"></a>00354         <span class="keywordtype">int</span> exp_y = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6584ca84bd2828a5ae70150b229d7fcb">y</a>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="comment">//close the state</span>
<a name="l00357"></a>00357         pbClosed[exp_x + width_ * exp_y] = 1;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="comment">//iterate over successors</span>
<a name="l00360"></a>00360         <span class="keywordtype">int</span> expcost = Grid2D[exp_x][exp_y];
<a name="l00361"></a>00361         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="2_dgridsearch_8h.html#ac00b6018cf9d45085302dc54d62128b0">SBPL_2DGRIDSEARCH_NUMOF2DDIRS</a>; dir++) {
<a name="l00362"></a>00362             <span class="keywordtype">int</span> newx = exp_x + dx_[dir];
<a name="l00363"></a>00363             <span class="keywordtype">int</span> newy = exp_y + dy_[dir];
<a name="l00364"></a>00364 
<a name="l00365"></a>00365             <span class="comment">//make sure it is inside the map and has no obstacle</span>
<a name="l00366"></a>00366             <span class="keywordflow">if</span> (!withinMap(newx, newy)) <span class="keywordflow">continue</span>;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368             <span class="keywordflow">if</span> (pbClosed[newx + width_ * newy] == 1) <span class="keywordflow">continue</span>;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370             <span class="comment">//compute the cost</span>
<a name="l00371"></a>00371             <span class="keywordtype">int</span> mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(Grid2D[newx][newy], expcost);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="preprocessor">#if SBPL_2DGRIDSEARCH_NUMOF2DDIRS &gt; 8</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(dir &gt; 7) {
<a name="l00375"></a>00375                 <span class="comment">//check two more cells through which the action goes</span>
<a name="l00376"></a>00376                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx0intersects_[dir]][exp_y + dy0intersects_[dir]]);
<a name="l00377"></a>00377                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx1intersects_[dir]][exp_y + dy1intersects_[dir]]);
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379 <span class="preprocessor">#endif</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span>
<a name="l00381"></a>00381             <span class="keywordflow">if</span> (mapcost &gt;= obsthresh) <span class="comment">//obstacle encountered</span>
<a name="l00382"></a>00382             <span class="keywordflow">continue</span>;
<a name="l00383"></a>00383             <span class="keywordtype">int</span> cost = (mapcost + 1) * dxy_distance_mm_[dir];
<a name="l00384"></a>00384 
<a name="l00385"></a>00385             <span class="comment">//get the predecessor</span>
<a name="l00386"></a>00386             searchPredState = &amp;searchStates2D_[newx][newy];
<a name="l00387"></a>00387 
<a name="l00388"></a>00388             <span class="comment">//update predecessor if necessary</span>
<a name="l00389"></a>00389             <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> != iteration_ || searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt; cost + searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>) {
<a name="l00390"></a>00390                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> = iteration_;
<a name="l00391"></a>00391                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = <a class="code" href="utils_8h.html#ad6d0138bf7e2cdaabeedc3fea40767ad">__min</a>(<a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>, cost + searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00392"></a>00392                 key = searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>;
<a name="l00393"></a>00393                 <span class="keywordflow">if</span> (termination_condition == <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86bafae8e152f0a268a7d66f24126d785f4c">SBPL_2DGRIDSEARCH_TERM_CONDITION_OPTPATHFOUND</a>)
<a name="l00394"></a>00394                     <span class="comment">//use h-values only if we are NOT computing all state values</span>
<a name="l00395"></a>00395                     key = key + <a class="code" href="2_dgridsearch_8h.html#a37f43da9f86b8e0ff5a6186c32f0ee8f">SBPL_2DGRIDSEARCH_HEUR2D</a>(searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a752505e845397c09eb0916f1474166ad" title="coordinates">x</a>, searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6584ca84bd2828a5ae70150b229d7fcb">y</a>); 
<a name="l00396"></a>00396 
<a name="l00397"></a>00397                 <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_abstract_search_state.html#a6028421591a4fff1e72a3917fe1c7d7e" title="index of the state in the heap, typically used for membership in OPEN">heapindex</a> == 0)
<a name="l00398"></a>00398                     OPEN2D_-&gt;insertheap(searchPredState, key);
<a name="l00399"></a>00399                 <span class="keywordflow">else</span>
<a name="l00400"></a>00400                     OPEN2D_-&gt;updateheap(searchPredState, key);
<a name="l00401"></a>00401             }
<a name="l00402"></a>00402         } <span class="comment">//over successors</span>
<a name="l00403"></a>00403     }<span class="comment">//while</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="comment">//set lower bounds for the remaining states</span>
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (!OPEN2D_-&gt;emptyheap())
<a name="l00407"></a>00407         largestcomputedoptf_ = OPEN2D_-&gt;getminkeyheap();
<a name="l00408"></a>00408     <span class="keywordflow">else</span>
<a name="l00409"></a>00409         largestcomputedoptf_ = <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="keyword">delete</span>[] pbClosed;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>( <span class="stringliteral">&quot;# of expands during 2dgridsearch=%d time=%d msecs 2Dsolcost_inmm=%d &quot;</span>
<a name="l00414"></a>00414                 <span class="stringliteral">&quot;largestoptfval=%d (start=%d %d goal=%d %d)\n&quot;</span>,
<a name="l00415"></a>00415                 numofExpands, (<span class="keywordtype">int</span>)(((clock() - starttime) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC) * 1000),
<a name="l00416"></a>00416                 searchStates2D_[goalx_c][goaly_c].g, largestcomputedoptf_, startx_c, starty_c, goalx_c, goaly_c);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="comment">//experimental version</span>
<a name="l00422"></a>00422 <span class="comment">//have only one copy of a state in the list, but the order of expansions is</span>
<a name="l00423"></a>00423 <span class="comment">//BFS with possible re-expansions. Thus the order can be maintained by FIFO</span>
<a name="l00424"></a>00424 <span class="comment">//queue implemented by list (requires though the implementation of the lastelement in the list)</span>
<a name="l00425"></a>00425 <span class="keywordtype">bool</span> SBPL2DGridSearch::search_exp(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>** Grid2D, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obsthresh, <span class="keywordtype">int</span> startx_c, <span class="keywordtype">int</span> starty_c,
<a name="l00426"></a>00426                                   <span class="keywordtype">int</span> goalx_c, <span class="keywordtype">int</span> goaly_c)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchExpState = NULL;
<a name="l00429"></a>00429     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchPredState = NULL;
<a name="l00430"></a>00430     <span class="keywordtype">int</span> numofExpands = 0;
<a name="l00431"></a>00431     <a class="code" href="class_c_list.html">CList</a> OPEN2DLIST;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="comment">//get the current time</span>
<a name="l00434"></a>00434     clock_t starttime = clock();
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="comment">//closed = 0</span>
<a name="l00437"></a>00437     iteration_++;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="comment">//init start and goal coordinates</span>
<a name="l00440"></a>00440     startX_ = startx_c;
<a name="l00441"></a>00441     startY_ = starty_c;
<a name="l00442"></a>00442     goalX_ = goalx_c;
<a name="l00443"></a>00443     goalY_ = goaly_c;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="comment">//check the validity of start/goal</span>
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (!withinMap(startx_c, starty_c) || !withinMap(goalx_c, goaly_c)) {
<a name="l00447"></a>00447         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: grid2Dsearch is called on invalid start (%d %d) or goal(%d %d)\n&quot;</span>, startx_c, starty_c,
<a name="l00448"></a>00448                    goalx_c, goaly_c);
<a name="l00449"></a>00449         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="comment">// initialize the start and goal states</span>
<a name="l00453"></a>00453     searchExpState = &amp;searchStates2D_[startX_][startY_];
<a name="l00454"></a>00454     initializeSearchState2D(searchExpState);
<a name="l00455"></a>00455     <span class="comment">//no initialization for the goal state - it will reset iteration_ variable</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <span class="comment">//seed the search</span>
<a name="l00458"></a>00458     searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = 0;
<a name="l00459"></a>00459     searchExpState-&gt;<a class="code" href="class_abstract_search_state.html#a6fa076d630be77a1eb6cda16aede86ba" title="each state can be a member of at most two lists indices of lists are given in planner.h (e.g., STATEID2IND_SLOT0)">listelem</a>[<a class="code" href="2_dgridsearch_8h.html#ac3be0235b6bc2eecc4252721ef0897a5">SBPL_2DSEARCH_OPEN_LIST_ID</a>] = NULL;
<a name="l00460"></a>00460     OPEN2DLIST.<a class="code" href="class_c_list.html#ae1ec06108d737b5669728e7a31556197">insertinfront</a>(searchExpState, <a class="code" href="2_dgridsearch_8h.html#ac3be0235b6bc2eecc4252721ef0897a5">SBPL_2DSEARCH_OPEN_LIST_ID</a>);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">//the main repetition of expansions</span>
<a name="l00463"></a>00463     <span class="keywordflow">while</span> (!OPEN2DLIST.<a class="code" href="class_c_list.html#a52c3368b45c410ee9385b16e8cfb111a">empty</a>()) {
<a name="l00464"></a>00464         <span class="comment">//get the next state for expansion</span>
<a name="l00465"></a>00465         searchExpState = (<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>*)OPEN2DLIST.<a class="code" href="class_c_list.html#a823abb0c5ba9c7a3ec6a4dc765c354a3">getlast</a>();
<a name="l00466"></a>00466         OPEN2DLIST.<a class="code" href="class_c_list.html#adc153e2ff3768f303633f36e26dfb0a9">remove</a>(searchExpState, <a class="code" href="2_dgridsearch_8h.html#ac3be0235b6bc2eecc4252721ef0897a5">SBPL_2DSEARCH_OPEN_LIST_ID</a>);
<a name="l00467"></a>00467         numofExpands++;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="keywordtype">int</span> exp_x = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a752505e845397c09eb0916f1474166ad" title="coordinates">x</a>;
<a name="l00470"></a>00470         <span class="keywordtype">int</span> exp_y = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6584ca84bd2828a5ae70150b229d7fcb">y</a>;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472         <span class="comment">//iterate over successors</span>
<a name="l00473"></a>00473         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="2_dgridsearch_8h.html#ac00b6018cf9d45085302dc54d62128b0">SBPL_2DGRIDSEARCH_NUMOF2DDIRS</a>; dir++) {
<a name="l00474"></a>00474             <span class="keywordtype">int</span> newx = exp_x + dx_[dir];
<a name="l00475"></a>00475             <span class="keywordtype">int</span> newy = exp_y + dy_[dir];
<a name="l00476"></a>00476 
<a name="l00477"></a>00477             <span class="comment">//make sure it is inside the map and has no obstacle</span>
<a name="l00478"></a>00478             <span class="keywordflow">if</span> (!withinMap(newx, newy)) <span class="keywordflow">continue</span>;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480             <span class="comment">//compute the cost</span>
<a name="l00481"></a>00481             <span class="keywordtype">int</span> mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(Grid2D[newx][newy], Grid2D[exp_x][exp_y]);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="preprocessor">#if SBPL_2DGRIDSEARCH_NUMOF2DDIRS &gt; 8</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(dir &gt; 7) {
<a name="l00485"></a>00485                 <span class="comment">//check two more cells through which the action goes</span>
<a name="l00486"></a>00486                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx0intersects_[dir]][exp_y + dy0intersects_[dir]]);
<a name="l00487"></a>00487                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx1intersects_[dir]][exp_y + dy1intersects_[dir]]);
<a name="l00488"></a>00488             }
<a name="l00489"></a>00489 <span class="preprocessor">#endif</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span>
<a name="l00491"></a>00491             <span class="keywordflow">if</span> (mapcost &gt;= obsthresh) <span class="comment">//obstacle encountered</span>
<a name="l00492"></a>00492             <span class="keywordflow">continue</span>;
<a name="l00493"></a>00493             <span class="keywordtype">int</span> cost = (mapcost + 1) * dxy_distance_mm_[dir];
<a name="l00494"></a>00494 
<a name="l00495"></a>00495             <span class="comment">//get the predecessor</span>
<a name="l00496"></a>00496             searchPredState = &amp;searchStates2D_[newx][newy];
<a name="l00497"></a>00497 
<a name="l00498"></a>00498             <span class="comment">//clear the list</span>
<a name="l00499"></a>00499             <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> != iteration_) searchPredState-&gt;<a class="code" href="class_abstract_search_state.html#a6fa076d630be77a1eb6cda16aede86ba" title="each state can be a member of at most two lists indices of lists are given in planner.h (e.g., STATEID2IND_SLOT0)">listelem</a>[<a class="code" href="2_dgridsearch_8h.html#ac3be0235b6bc2eecc4252721ef0897a5">SBPL_2DSEARCH_OPEN_LIST_ID</a>]
<a name="l00500"></a>00500                 = NULL;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502             <span class="comment">//update predecessor if necessary</span>
<a name="l00503"></a>00503             <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> != iteration_ || searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt; cost + searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>) {
<a name="l00504"></a>00504                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> = iteration_;
<a name="l00505"></a>00505                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = <a class="code" href="utils_8h.html#ad6d0138bf7e2cdaabeedc3fea40767ad">__min</a>(<a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>, cost + searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507                 <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt;= <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>) {
<a name="l00508"></a>00508                     <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: infinite g\n&quot;</span>);
<a name="l00509"></a>00509                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_s_b_p_l___exception.html">SBPL_Exception</a>();
<a name="l00510"></a>00510                 }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512                 <span class="comment">//put it into the list if not there already</span>
<a name="l00513"></a>00513                 <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_abstract_search_state.html#a6fa076d630be77a1eb6cda16aede86ba" title="each state can be a member of at most two lists indices of lists are given in planner.h (e.g., STATEID2IND_SLOT0)">listelem</a>[<a class="code" href="2_dgridsearch_8h.html#ac3be0235b6bc2eecc4252721ef0897a5">SBPL_2DSEARCH_OPEN_LIST_ID</a>] == NULL)
<a name="l00514"></a>00514                     OPEN2DLIST.<a class="code" href="class_c_list.html#ae1ec06108d737b5669728e7a31556197">insertinfront</a>(searchPredState, <a class="code" href="2_dgridsearch_8h.html#ac3be0235b6bc2eecc4252721ef0897a5">SBPL_2DSEARCH_OPEN_LIST_ID</a>);
<a name="l00515"></a>00515                 <span class="comment">//otherwise, the state remains where it is but it now has a new g-value</span>
<a name="l00516"></a>00516             }
<a name="l00517"></a>00517         } <span class="comment">//over successors</span>
<a name="l00518"></a>00518     }<span class="comment">//while</span>
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="comment">//set lower bounds for the remaining states - none left since we exhausted the whole list</span>
<a name="l00521"></a>00521     largestcomputedoptf_ = <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>( <span class="stringliteral">&quot;# of expands during 2dgridsearch=%d time=%d msecs 2Dsolcost_inmm=%d &quot;</span>
<a name="l00524"></a>00524                 <span class="stringliteral">&quot;largestoptfval=%d (start=%d %d goal=%d %d)\n&quot;</span>,
<a name="l00525"></a>00525                 numofExpands, (<span class="keywordtype">int</span>)(((clock() - starttime) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC) * 1000),
<a name="l00526"></a>00526                 searchStates2D_[goalx_c][goaly_c].g, largestcomputedoptf_, startx_c, starty_c, goalx_c, goaly_c);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 <span class="comment">//experimental version</span>
<a name="l00532"></a>00532 <span class="comment">//OPEN list is implemented as a bucket list</span>
<a name="l00533"></a>00533 <span class="keywordtype">bool</span> SBPL2DGridSearch::search_withbuckets(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>** Grid2D, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obsthresh, <span class="keywordtype">int</span> startx_c, <span class="keywordtype">int</span> starty_c,
<a name="l00534"></a>00534                                           <span class="keywordtype">int</span> goalx_c, <span class="keywordtype">int</span> goaly_c)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchExpState = NULL;
<a name="l00537"></a>00537     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchPredState = NULL;
<a name="l00538"></a>00538     <span class="keywordtype">int</span> numofExpands = 0;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="comment">//get the current time</span>
<a name="l00541"></a>00541     clock_t starttime = clock();
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="comment">//int max_bucketed_priority = obsthresh*10*__max(this-&gt;width_, this-&gt;height_);</span>
<a name="l00544"></a>00544     <span class="keywordtype">int</span> max_bucketed_priority = (int)(0.1 * obsthresh * dxy_distance_mm_[0] * <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(this-&gt;width_, this-&gt;height_));
<a name="l00545"></a>00545     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>(<span class="stringliteral">&quot;bucket-based OPEN2D has up to %d bucketed priorities, the rest will be unsorted\n&quot;</span>,
<a name="l00546"></a>00546                 max_bucketed_priority);
<a name="l00547"></a>00547     <a class="code" href="class_c_bucket.html">CBucket</a> OPEN2DBLIST(0, max_bucketed_priority);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>(<span class="stringliteral">&quot;OPEN2D allocation time=%d msecs\n&quot;</span>, (<span class="keywordtype">int</span>)(((clock() - starttime) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC) * 1000));
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">//closed = 0</span>
<a name="l00552"></a>00552     iteration_++;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">//init start and goal coordinates</span>
<a name="l00555"></a>00555     startX_ = startx_c;
<a name="l00556"></a>00556     startY_ = starty_c;
<a name="l00557"></a>00557     goalX_ = goalx_c;
<a name="l00558"></a>00558     goalY_ = goaly_c;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="comment">//check the validity of start/goal</span>
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (!withinMap(startx_c, starty_c) || !withinMap(goalx_c, goaly_c)) {
<a name="l00562"></a>00562         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: grid2Dsearch is called on invalid start (%d %d) or goal(%d %d)\n&quot;</span>, startx_c, starty_c,
<a name="l00563"></a>00563                    goalx_c, goaly_c);
<a name="l00564"></a>00564         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="comment">// initialize the start and goal states</span>
<a name="l00568"></a>00568     searchExpState = &amp;searchStates2D_[startX_][startY_];
<a name="l00569"></a>00569     initializeSearchState2D(searchExpState);
<a name="l00570"></a>00570     <span class="comment">//no initialization for the goal state - it will reset iteration_ variable</span>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     <span class="comment">//seed the search</span>
<a name="l00573"></a>00573     searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = 0;
<a name="l00574"></a>00574     searchExpState-&gt;<a class="code" href="class_abstract_search_state.html#a6028421591a4fff1e72a3917fe1c7d7e" title="index of the state in the heap, typically used for membership in OPEN">heapindex</a> = -1;
<a name="l00575"></a>00575     OPEN2DBLIST.insert(searchExpState, searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="comment">//the main repetition of expansions</span>
<a name="l00578"></a>00578     <span class="keywordflow">while</span> (!OPEN2DBLIST.empty()) {
<a name="l00579"></a>00579         <span class="comment">//get the next state for expansion</span>
<a name="l00580"></a>00580         searchExpState = (<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>*)OPEN2DBLIST.popminelement();
<a name="l00581"></a>00581         numofExpands++;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <span class="keywordtype">int</span> exp_x = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a752505e845397c09eb0916f1474166ad" title="coordinates">x</a>;
<a name="l00584"></a>00584         <span class="keywordtype">int</span> exp_y = searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6584ca84bd2828a5ae70150b229d7fcb">y</a>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="comment">//iterate over successors</span>
<a name="l00587"></a>00587         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="2_dgridsearch_8h.html#ac00b6018cf9d45085302dc54d62128b0">SBPL_2DGRIDSEARCH_NUMOF2DDIRS</a>; dir++) {
<a name="l00588"></a>00588             <span class="keywordtype">int</span> newx = exp_x + dx_[dir];
<a name="l00589"></a>00589             <span class="keywordtype">int</span> newy = exp_y + dy_[dir];
<a name="l00590"></a>00590 
<a name="l00591"></a>00591             <span class="comment">//make sure it is inside the map and has no obstacle</span>
<a name="l00592"></a>00592             <span class="keywordflow">if</span> (!withinMap(newx, newy)) <span class="keywordflow">continue</span>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594             <span class="comment">//compute the cost</span>
<a name="l00595"></a>00595             <span class="keywordtype">int</span> mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(Grid2D[newx][newy], Grid2D[exp_x][exp_y]);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="preprocessor">#if SBPL_2DGRIDSEARCH_NUMOF2DDIRS &gt; 8</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(dir &gt; 7) {
<a name="l00599"></a>00599                 <span class="comment">//check two more cells through which the action goes</span>
<a name="l00600"></a>00600                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx0intersects_[dir]][exp_y + dy0intersects_[dir]]);
<a name="l00601"></a>00601                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx1intersects_[dir]][exp_y + dy1intersects_[dir]]);
<a name="l00602"></a>00602             }
<a name="l00603"></a>00603 <span class="preprocessor">#endif</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span>
<a name="l00605"></a>00605             <span class="keywordflow">if</span> (mapcost &gt;= obsthresh) <span class="comment">//obstacle encountered</span>
<a name="l00606"></a>00606             <span class="keywordflow">continue</span>;
<a name="l00607"></a>00607             <span class="keywordtype">int</span> cost = (mapcost + 1) * dxy_distance_mm_[dir];
<a name="l00608"></a>00608 
<a name="l00609"></a>00609             <span class="comment">//get the predecessor</span>
<a name="l00610"></a>00610             searchPredState = &amp;searchStates2D_[newx][newy];
<a name="l00611"></a>00611 
<a name="l00612"></a>00612             <span class="comment">//clear the element from OPEN</span>
<a name="l00613"></a>00613             <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> != iteration_) searchPredState-&gt;<a class="code" href="class_abstract_search_state.html#a6028421591a4fff1e72a3917fe1c7d7e" title="index of the state in the heap, typically used for membership in OPEN">heapindex</a> = -1;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615             <span class="comment">//update predecessor if necessary</span>
<a name="l00616"></a>00616             <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> != iteration_ || searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt; cost + searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>) {
<a name="l00617"></a>00617                 <span class="keywordtype">int</span> oldstatepriority = searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>;
<a name="l00618"></a>00618                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> = iteration_;
<a name="l00619"></a>00619                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = <a class="code" href="utils_8h.html#ad6d0138bf7e2cdaabeedc3fea40767ad">__min</a>(<a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>, cost + searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621                 <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt;= <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>) {
<a name="l00622"></a>00622                     <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: infinite g\n&quot;</span>);
<a name="l00623"></a>00623                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_s_b_p_l___exception.html">SBPL_Exception</a>();
<a name="l00624"></a>00624                 }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626                 <span class="comment">//put it into the list if not there already</span>
<a name="l00627"></a>00627                 <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_abstract_search_state.html#a6028421591a4fff1e72a3917fe1c7d7e" title="index of the state in the heap, typically used for membership in OPEN">heapindex</a> != -1) OPEN2DBLIST.remove(searchPredState, oldstatepriority);
<a name="l00628"></a>00628                 OPEN2DBLIST.insert(searchPredState, searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00629"></a>00629             }
<a name="l00630"></a>00630         } <span class="comment">//over successors</span>
<a name="l00631"></a>00631     }<span class="comment">//while</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="comment">//set lower bounds for the remaining states</span>
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (!OPEN2DBLIST.empty())
<a name="l00635"></a>00635         largestcomputedoptf_ = OPEN2DBLIST.getminpriority();
<a name="l00636"></a>00636     <span class="keywordflow">else</span>
<a name="l00637"></a>00637         largestcomputedoptf_ = <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>( <span class="stringliteral">&quot;# of expands during 2dgridsearch=%d time=%d msecs 2Dsolcost_inmm=%d &quot;</span>
<a name="l00640"></a>00640                 <span class="stringliteral">&quot;largestoptfval=%d bucketassortedarraymaxsize=%d (start=%d %d goal=%d %d)\n&quot;</span>,
<a name="l00641"></a>00641                 numofExpands, (<span class="keywordtype">int</span>)(((clock() - starttime) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC) * 1000),
<a name="l00642"></a>00642                 searchStates2D_[goalx_c][goaly_c].g, largestcomputedoptf_, OPEN2DBLIST.maxassortedpriorityVsize,
<a name="l00643"></a>00643                 startx_c, starty_c, goalx_c, goaly_c);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">//experimental version</span>
<a name="l00649"></a>00649 <span class="comment">//OPEN list is implemented as a sliding bucket list</span>
<a name="l00650"></a>00650 <span class="keywordtype">bool</span> SBPL2DGridSearch::search_withslidingbuckets(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>** Grid2D, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obsthresh, <span class="keywordtype">int</span> startx_c,
<a name="l00651"></a>00651                                                  <span class="keywordtype">int</span> starty_c, <span class="keywordtype">int</span> goalx_c, <span class="keywordtype">int</span> goaly_c,
<a name="l00652"></a>00652                                                  <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86b">SBPL_2DGRIDSEARCH_TERM_CONDITION</a> termination_condition)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchExpState = NULL;
<a name="l00655"></a>00655     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a> *searchPredState = NULL;
<a name="l00656"></a>00656     <span class="keywordtype">int</span> numofExpands = 0;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="preprocessor">#if DEBUG</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span><span class="preprocessor">#ifndef ROS</span>
<a name="l00660"></a>00660 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span>* f2dgriddebug = <span class="stringliteral">&quot;2dgriddebug.txt&quot;</span>;
<a name="l00661"></a>00661 <span class="preprocessor">#endif</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span>    FILE* f2Dsearch = <a class="code" href="config_8h.html#abf7ed5a123e4b1715dd437bcb70e4ef9">SBPL_FOPEN</a>(f2dgriddebug, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l00663"></a>00663 <span class="preprocessor">#endif</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span>
<a name="l00665"></a>00665     <span class="comment">//closed = 0</span>
<a name="l00666"></a>00666     iteration_++;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="comment">//init start and goal coordinates</span>
<a name="l00669"></a>00669     startX_ = startx_c;
<a name="l00670"></a>00670     startY_ = starty_c;
<a name="l00671"></a>00671     goalX_ = goalx_c;
<a name="l00672"></a>00672     goalY_ = goaly_c;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <span class="comment">//check the validity of start/goal</span>
<a name="l00675"></a>00675     <span class="keywordflow">if</span> (!withinMap(startx_c, starty_c) || !withinMap(goalx_c, goaly_c)) {
<a name="l00676"></a>00676         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: grid2Dsearch is called on invalid start (%d %d) or goal(%d %d)\n&quot;</span>, startx_c, starty_c,
<a name="l00677"></a>00677                    goalx_c, goaly_c);
<a name="l00678"></a>00678 <span class="preprocessor">#if DEBUG</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>        <a class="code" href="config_8h.html#a28856faf6cdc3815a09e57d383cde6f0">SBPL_FCLOSE</a>(f2Dsearch);
<a name="l00680"></a>00680 <span class="preprocessor">#endif</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="comment">//reset OPEN</span>
<a name="l00685"></a>00685     OPEN2DBLIST_-&gt;reset();
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <span class="comment">//set the term. condition</span>
<a name="l00688"></a>00688     term_condition_usedlast = termination_condition;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="comment">// initialize the start and goal states</span>
<a name="l00691"></a>00691     searchExpState = &amp;searchStates2D_[startX_][startY_];
<a name="l00692"></a>00692     initializeSearchState2D(searchExpState);
<a name="l00693"></a>00693     initializeSearchState2D(&amp;searchStates2D_[goalx_c][goaly_c]);
<a name="l00694"></a>00694     <a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>* search2DGoalState = &amp;searchStates2D_[goalx_c][goaly_c];
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="comment">//seed the search</span>
<a name="l00697"></a>00697     searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = 0;
<a name="l00698"></a>00698     OPEN2DBLIST_-&gt;insert(searchExpState, searchExpState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">//set the termination condition</span>
<a name="l00701"></a>00701     <span class="keywordtype">float</span> term_factor = 0.0;
<a name="l00702"></a>00702     <span class="keywordflow">switch</span> (termination_condition) {
<a name="l00703"></a>00703     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86bafae8e152f0a268a7d66f24126d785f4c">SBPL_2DGRIDSEARCH_TERM_CONDITION_OPTPATHFOUND</a>:
<a name="l00704"></a>00704         term_factor = 1;
<a name="l00705"></a>00705         <span class="keywordflow">break</span>;
<a name="l00706"></a>00706     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86bae9b331875a0820a23510216a1ad8b65a">SBPL_2DGRIDSEARCH_TERM_CONDITION_20PERCENTOVEROPTPATH</a>:
<a name="l00707"></a>00707         term_factor = (float)(1.0 / 1.2);
<a name="l00708"></a>00708         <span class="keywordflow">break</span>;
<a name="l00709"></a>00709     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba29052a8c8b576fef6ee4de7e3fef0616">SBPL_2DGRIDSEARCH_TERM_CONDITION_TWOTIMESOPTPATH</a>:
<a name="l00710"></a>00710         term_factor = 0.5;
<a name="l00711"></a>00711         <span class="keywordflow">break</span>;
<a name="l00712"></a>00712     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba4894b5f52245db38fd6a243da74b0bff">SBPL_2DGRIDSEARCH_TERM_CONDITION_THREETIMESOPTPATH</a>:
<a name="l00713"></a>00713         term_factor = (float)(1.0 / 3.0);
<a name="l00714"></a>00714         <span class="keywordflow">break</span>;
<a name="l00715"></a>00715     <span class="keywordflow">case</span> <a class="code" href="2_dgridsearch_8h.html#a966f68e754058798c004bcb0e6dde86ba0040a65fda1344baec0ccaac1f22e14e">SBPL_2DGRIDSEARCH_TERM_CONDITION_ALLCELLS</a>:
<a name="l00716"></a>00716         term_factor = 0.0;
<a name="l00717"></a>00717         <span class="keywordflow">break</span>;
<a name="l00718"></a>00718     <span class="keywordflow">default</span>:
<a name="l00719"></a>00719         <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: incorrect termination factor for grid2Dsearch\n&quot;</span>);
<a name="l00720"></a>00720         term_factor = 0.0;
<a name="l00721"></a>00721     };
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="comment">//get the current time</span>
<a name="l00724"></a>00724     clock_t starttime = clock();
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordtype">char</span> *pbClosed = (<span class="keywordtype">char</span>*)calloc(1, width_ * height_);
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     <span class="comment">//the main repetition of expansions</span>
<a name="l00729"></a>00729     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>(<span class="stringliteral">&quot;2D search with sliding buckets and term_factor=%.3f\n&quot;</span>, term_factor);
<a name="l00730"></a>00730     <span class="keywordtype">int</span> prevg = 0;
<a name="l00731"></a>00731     <span class="keywordflow">while</span> (!OPEN2DBLIST_-&gt;empty() &amp;&amp; search2DGoalState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt; term_factor * OPEN2DBLIST_-&gt;getminkey()) {
<a name="l00732"></a>00732 <span class="preprocessor">#if DEBUG</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span>        <a class="code" href="config_8h.html#a7cd4beba805993dccfd4fb6ceb17c9e3">SBPL_FPRINTF</a>(f2Dsearch, <span class="stringliteral">&quot;currentminelement_priority before pop=%d\n&quot;</span>, OPEN2DBLIST_-&gt;getminkey());
<a name="l00734"></a>00734 <span class="preprocessor">#endif</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>
<a name="l00736"></a>00736         <span class="comment">//get the next state for expansion</span>
<a name="l00737"></a>00737         searchExpState = (<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>*)OPEN2DBLIST_-&gt;popminelement();
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         <span class="keywordflow">if</span> (searchExpState-&gt;g &gt; OPEN2DBLIST_-&gt;getminkey()) {
<a name="l00740"></a>00740             <a class="code" href="config_8h.html#aec65b814c59b7943d3a1c49ee49349fe">SBPL_ERROR</a>(<span class="stringliteral">&quot;ERROR: g=%d for state %d %d but minpriority=%d (prevg=%d)\n&quot;</span>, searchExpState-&gt;g,
<a name="l00741"></a>00741                        searchExpState-&gt;x, searchExpState-&gt;y, OPEN2DBLIST_-&gt;getminkey(), prevg);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743         prevg = searchExpState-&gt;g;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         <span class="keywordtype">int</span> exp_x = searchExpState-&gt;x;
<a name="l00746"></a>00746         <span class="keywordtype">int</span> exp_y = searchExpState-&gt;y;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         <span class="comment">//close the state if it wasn&#39;t yet</span>
<a name="l00749"></a>00749         <span class="keywordflow">if</span> (pbClosed[exp_x + width_ * exp_y] == 1) <span class="keywordflow">continue</span>;
<a name="l00750"></a>00750         pbClosed[exp_x + width_ * exp_y] = 1;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752 <span class="preprocessor">#if DEBUG</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span>        <a class="code" href="config_8h.html#a7cd4beba805993dccfd4fb6ceb17c9e3">SBPL_FPRINTF</a>(f2Dsearch, <span class="stringliteral">&quot;expanding state &lt;%d %d&gt; with g=%d &quot;</span>
<a name="l00754"></a>00754                      <span class="stringliteral">&quot;(currentminelement_priority=%d, currentfirstbucket_bindex=%d, currentfirstbucket_priority=%d)\n&quot;</span>,
<a name="l00755"></a>00755                      searchExpState-&gt;x, searchExpState-&gt;y, searchExpState-&gt;g, OPEN2DBLIST_-&gt;getminkey(),
<a name="l00756"></a>00756                      OPEN2DBLIST_-&gt;currentfirstbucket_bindex, OPEN2DBLIST_-&gt;currentfirstbucket_priority);
<a name="l00757"></a>00757 <span class="preprocessor">#endif</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>
<a name="l00759"></a>00759         <span class="comment">//expand</span>
<a name="l00760"></a>00760         numofExpands++;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762         <span class="comment">//iterate over successors</span>
<a name="l00763"></a>00763         <span class="keywordtype">int</span> expcost = Grid2D[exp_x][exp_y];
<a name="l00764"></a>00764         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="2_dgridsearch_8h.html#ac00b6018cf9d45085302dc54d62128b0">SBPL_2DGRIDSEARCH_NUMOF2DDIRS</a>; dir++) {
<a name="l00765"></a>00765             <span class="keywordtype">int</span> newx = exp_x + dx_[dir];
<a name="l00766"></a>00766             <span class="keywordtype">int</span> newy = exp_y + dy_[dir];
<a name="l00767"></a>00767 
<a name="l00768"></a>00768             <span class="comment">//make sure it is inside the map and has no obstacle</span>
<a name="l00769"></a>00769             <span class="keywordflow">if</span> (!withinMap(newx, newy)) <span class="keywordflow">continue</span>;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771             <span class="keywordflow">if</span> (pbClosed[newx + width_ * newy] == 1) <span class="keywordflow">continue</span>;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773             <span class="comment">//compute the cost</span>
<a name="l00774"></a>00774             <span class="keywordtype">int</span> mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(Grid2D[newx][newy], expcost);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 <span class="preprocessor">#if SBPL_2DGRIDSEARCH_NUMOF2DDIRS &gt; 8</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(dir &gt; 7) {
<a name="l00778"></a>00778                 <span class="comment">//check two more cells through which the action goes</span>
<a name="l00779"></a>00779                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx0intersects_[dir]][exp_y + dy0intersects_[dir]]);
<a name="l00780"></a>00780                 mapcost = <a class="code" href="utils_8h.html#af643213a7d426b69429d1430cef4ecbb">__max</a>(mapcost, Grid2D[exp_x + dx1intersects_[dir]][exp_y + dy1intersects_[dir]]);
<a name="l00781"></a>00781             }
<a name="l00782"></a>00782 <span class="preprocessor">#endif</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>
<a name="l00784"></a>00784             <span class="keywordflow">if</span> (mapcost &gt;= obsthresh) <span class="comment">//obstacle encountered</span>
<a name="l00785"></a>00785             <span class="keywordflow">continue</span>;
<a name="l00786"></a>00786             <span class="keywordtype">int</span> cost = (mapcost + 1) * dxy_distance_mm_[dir];
<a name="l00787"></a>00787 
<a name="l00788"></a>00788             <span class="comment">//get the predecessor</span>
<a name="l00789"></a>00789             searchPredState = &amp;searchStates2D_[newx][newy];
<a name="l00790"></a>00790 
<a name="l00791"></a>00791             <span class="comment">//update predecessor if necessary</span>
<a name="l00792"></a>00792             <span class="keywordflow">if</span> (searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> != iteration_ || searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> &gt; cost + searchExpState-&gt;g) {
<a name="l00793"></a>00793                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a7e97c861c063d26cc20974add6ea56df" title="iteration at which the state was accessed (generated) last">iterationaccessed</a> = iteration_;
<a name="l00794"></a>00794                 searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a> = <a class="code" href="utils_8h.html#ad6d0138bf7e2cdaabeedc3fea40767ad">__min</a>(<a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>, cost + searchExpState-&gt;g);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="preprocessor">#if DEBUG</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>                <a class="code" href="config_8h.html#a7cd4beba805993dccfd4fb6ceb17c9e3">SBPL_FPRINTF</a>(f2Dsearch, <span class="stringliteral">&quot;inserting state &lt;%d %d&gt; with g=%d\n&quot;</span>, searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a752505e845397c09eb0916f1474166ad" title="coordinates">x</a>, searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6584ca84bd2828a5ae70150b229d7fcb">y</a>, searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00798"></a>00798 <span class="preprocessor">#endif</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span>
<a name="l00800"></a>00800                 <span class="comment">//put it into the list</span>
<a name="l00801"></a>00801                 OPEN2DBLIST_-&gt;insert(searchPredState, searchPredState-&gt;<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html#a6b0616b03fa2fe0ad62495ccbafe7bfc" title="search relevant data">g</a>);
<a name="l00802"></a>00802             }
<a name="l00803"></a>00803         } <span class="comment">//over successors</span>
<a name="l00804"></a>00804     }<span class="comment">//while</span>
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <span class="comment">//set lower bounds for the remaining states</span>
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (!OPEN2DBLIST_-&gt;empty())
<a name="l00808"></a>00808         largestcomputedoptf_ = ((<a class="code" href="class_s_b_p_l__2_d_grid_search_state.html" title="search state corresponding to each 2D cell">SBPL_2DGridSearchState</a>*)OPEN2DBLIST_-&gt;getminelement())-&gt;g;
<a name="l00809"></a>00809     <span class="keywordflow">else</span>
<a name="l00810"></a>00810         largestcomputedoptf_ = <a class="code" href="key_8h.html#afc8375d739d221b5077960ee6b94ff88">INFINITECOST</a>;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     <span class="keyword">delete</span>[] pbClosed;
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     <a class="code" href="config_8h.html#a9122cfeed55bc021fcc2dd373b8cc47d">SBPL_PRINTF</a>( <span class="stringliteral">&quot;# of expands during 2dgridsearch=%d time=%d msecs 2Dsolcost_inmm=%d &quot;</span>
<a name="l00815"></a>00815                 <span class="stringliteral">&quot;largestoptfval=%d (start=%d %d goal=%d %d)\n&quot;</span>,
<a name="l00816"></a>00816                 numofExpands, (<span class="keywordtype">int</span>)(((clock() - starttime) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC) * 1000),
<a name="l00817"></a>00817                 searchStates2D_[goalx_c][goaly_c].g, largestcomputedoptf_, startx_c, starty_c, goalx_c, goaly_c);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="preprocessor">#if DEBUG</span>
<a name="l00820"></a>00820 <span class="preprocessor"></span>    <a class="code" href="config_8h.html#a28856faf6cdc3815a09e57d383cde6f0">SBPL_FCLOSE</a>(f2Dsearch);
<a name="l00821"></a>00821 <span class="preprocessor">#endif</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 <span class="comment">//----------------------------------------------------------------------------------------------------------------------</span>
<a name="l00826"></a>00826 
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="2_dgridsearch_8cpp.html">2Dgridsearch.cpp</a>      </li>

    <li class="footer">Generated on Thu Mar 21 2013 12:14:23 for SBPL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
